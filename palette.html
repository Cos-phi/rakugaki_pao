<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=750">
    <title>パレット編集 - rakugaki_pao</title>
    <link rel="stylesheet" type="text/css" href="style.css?v=22">
    <style>
        .palette-row { margin-bottom: 12px; }
        .palette-label { display: inline-block; width: 120px; }
        .palette-input { width: 120px; }
        .color-list { display: flex; gap: 8px; margin-bottom: 8px; }
        .color-item { display: flex; flex-direction: column; align-items: center; }
        .color-remove { margin-top: 2px; color: #c00; cursor: pointer; font-size: 12px; }
        .add-color-btn { margin-left: 8px; }
        .output-row { margin-top: 24px; }
        .output-box { width: 100%; font-size: 14px; }
    </style>
</head>
<body>
    <div id="app" style="max-width: 480px; margin: 32px auto;">


        <h2>パレット編集</h2>
        <div class="palette-row">
            <span class="palette-label">黒ペン色</span>
            <input type="color" id="blackPenColor" value="#36364A">
        </div>
        <div class="palette-row">
            <span class="palette-label">背景色</span>
            <input type="color" id="backgroundColor" value="#F2EEE6">
        </div>
        <div class="palette-row">
            <span class="palette-label">パレット色</span>
            <div id="paletteColors" class="color-list"></div>
            <button id="addPaletteColor" class="add-color-btn">色を追加</button>
        </div>
        <div class="palette-row">
            <span class="palette-label">変更可能色</span>
            <input type="color" id="changeableColor" value="#C3C3C3">
        </div>
        <div class="output-row">
            <button id="addToList">パレットリストに保存</button>
            <button id="saveToLocal">rakugaki_paoに反映</button>
        </div>
        <hr>
        <h2>保存済みパレットセット</h2>
        <div class="output-row" id="paletteSetListContainer">
            <div id="paletteSetList"></div>
        </div>

    </div>
    <script>
        // 初期値
        const defaultColors = ["#FBA9A7", "#FAC48D", "#F9F19A", "#7BB07F", "#9DBEEA", "#D4C8F4", "#F0C6F0"];
        let blackPenColor = "#36364A";
        let backgroundColor = "#F2EEE6";
        let paletteColors;
        let changeableColor = "#C3C3C3";
        let paletteStr = '';
        const localstorageKeyPalette = 'palettecolorskey';

        // paletteColorsの初期値をlocalstorageKeyPaletteから読み込み
        (function(){
            let paletteStr = window.localStorage.getItem(localstorageKeyPalette);
            if(paletteStr){
                let [mainPart, palettePart, changeablePart] = paletteStr.split('|');
                let [bpc, bgc] = (mainPart || '').split(',');
                if(bpc) blackPenColor = bpc;
                if(bgc) backgroundColor = bgc;
                paletteColors = palettePart ? palettePart.split(',') : [...defaultColors];
                if(changeablePart) changeableColor = changeablePart;
            } else {
                paletteColors = [...defaultColors];
            }
        })();

        // 要素取得
        const blackPenColorInput = document.getElementById('blackPenColor');
        const backgroundColorInput = document.getElementById('backgroundColor');
        const paletteColorsDiv = document.getElementById('paletteColors');
        const addPaletteColorBtn = document.getElementById('addPaletteColor');
        const changeableColorInput = document.getElementById('changeableColor');
        const addToListBtn = document.getElementById('addToList');
        const saveToLocal = document.getElementById('saveToLocal');
        const paletteSetList = document.getElementById('paletteSetList');
        const paletteSetListContainer = document.getElementById('paletteSetListContainer');
        const paletteSetStorageKey = 'paletteSetList';

        // デフォルトサンプル3セット
        const defaultPaletteSets = [
            {
                name: 'デフォルト',
                str: '#36364A,#F2EEE6|#FBA9A7,#FAC48D,#F9F19A,#7BB07F,#9DBEEA,#D4C8F4,#F0C6F0|#C3C3C3'
            },
            {
                name: 'サンプル2',
                str: '#222222,#FFFFFF|#FF0000,#00FF00,#0000FF,#FFFF00,#FF00FF,#00FFFF,#888888|#EEEEEE'
            },
            {
                name: 'サンプル3',
                str: '#3C3320,#F2EEE6|#FFD700,#FF8C00,#FF69B4,#8A2BE2,#00CED1,#228B22,#DC143C|#FFFFFF'
            }
        ];

        // パレットセットリスト取得
        function getPaletteSetList() {
            let list = JSON.parse(window.localStorage.getItem(paletteSetStorageKey) || '[]');
            if(list.length === 0) {
                list = [...defaultPaletteSets];
                window.localStorage.setItem(paletteSetStorageKey, JSON.stringify(list));
            }
            return list;
        }
        // パレットセットリスト保存
        function setPaletteSetList(list) {
            window.localStorage.setItem(paletteSetStorageKey, JSON.stringify(list));
        }
        // パレットセット追加
        function addPaletteSet(str) {
            let list = getPaletteSetList();
            const name = 'セット' + (list.length+1);
            list.push({name, str});
            setPaletteSetList(list);
            renderPaletteSetList();
        }
        // パレットセット削除
        function deletePaletteSet(idx) {
            let list = getPaletteSetList();
            list.splice(idx,1);
            setPaletteSetList(list);
            renderPaletteSetList();
        }
        // パレットセット反映
        function applyPaletteSet(str) {
            let [mainPart, palettePart, changeablePart] = str.split('|');
            let [bpc, bgc] = (mainPart || '').split(',');
            if(bpc) blackPenColor = bpc;
            if(bgc) backgroundColor = bgc;
            paletteColors = palettePart ? palettePart.split(',') : [...defaultColors];
            changeableColor = changeablePart || defaultChangeableColor;
            syncInputs();
            updateAll();
        }
        // パレットセットリスト描画
        function renderPaletteSetList() {
            let list = getPaletteSetList();
            paletteSetList.innerHTML = '';
            list.forEach((set, idx) => {
                const div = document.createElement('div');
                div.style.display = 'flex';
                div.style.alignItems = 'center';
                div.style.marginBottom = '8px';
                const nameSpan = document.createElement('span');
                nameSpan.textContent = set.name;
                nameSpan.style.width = '120px';
                nameSpan.style.marginRight = '8px';
                const applyBtn = document.createElement('button');
                applyBtn.textContent = '読込';
                applyBtn.style.marginRight = '4px';
                applyBtn.addEventListener('click', () => applyPaletteSet(set.str));
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = '削除';
                deleteBtn.style.marginRight = '4px';
                deleteBtn.addEventListener('click', () => deletePaletteSet(idx));
                // 色プレビュー
                const previewDiv = document.createElement('div');
                previewDiv.style.display = 'flex';
                previewDiv.style.marginLeft = '8px';
                previewDiv.style.marginRight = '8px';
                let [mainPart, palettePart, changeablePart] = set.str.split('|');
                let [bpc, bgc] = (mainPart || '').split(',');
                let colors = [];
                if(bpc) colors.push(bpc);
                if(bgc) colors.push(bgc);
                if(palettePart) colors = colors.concat(palettePart.split(','));
                if(changeablePart) colors.push(changeablePart);
                colors.slice(0,10).forEach(color => {
                    const box = document.createElement('div');
                    box.style.width = '42px';
                    box.style.height = '42px';
                    box.style.background = color;
                    box.style.border = '1px solid #36364A';
                    box.style.marginRight = '2px';
                    previewDiv.appendChild(box);
                });
                div.appendChild(nameSpan);
                div.appendChild(applyBtn);
                div.appendChild(deleteBtn);
                div.appendChild(previewDiv);
                paletteSetList.appendChild(div);
            });
        }
        // 保存ボタンでセット追加
        addToListBtn.addEventListener('click', () => {
            addPaletteSet(paletteStr);
            alert('パレットリストに保存しました');
        });
        // rakugaki_pao反映ボタン
        saveToLocal.addEventListener('click', () => {
            // input要素の値を変数に反映
            blackPenColor = blackPenColorInput.value;
            backgroundColor = backgroundColorInput.value;
            changeableColor = changeableColorInput.value;
            updateAll(); // 最新のpaletteStrを生成
            window.localStorage.setItem(localstorageKeyPalette, paletteStr);
            alert('rakugaki_paoに反映しました');
        });



        // 色リスト描画
        function renderPaletteColors() {
            paletteColorsDiv.innerHTML = '';
            paletteColors.forEach((color, idx) => {
                const item = document.createElement('div');
                item.className = 'color-item';
                const colorInput = document.createElement('input');
                colorInput.type = 'color';
                colorInput.value = color;
                colorInput.addEventListener('input', e => {
                    paletteColors[idx] = e.target.value;
                });
                colorInput.addEventListener('change', e => {
                    paletteColors[idx] = e.target.value;
                    updateAll();
                });
                // 並び替えボタン
                const leftBtn = document.createElement('button');
                leftBtn.textContent = '<';
                leftBtn.style.margin = '2px';
                leftBtn.disabled = (idx === 0);
                leftBtn.addEventListener('click', () => {
                    if(idx > 0){
                        [paletteColors[idx-1], paletteColors[idx]] = [paletteColors[idx], paletteColors[idx-1]];
                        updateAll();
                    }
                });
                const rightBtn = document.createElement('button');
                rightBtn.textContent = '>';
                rightBtn.style.margin = '2px';
                rightBtn.disabled = (idx === paletteColors.length-1);
                rightBtn.addEventListener('click', () => {
                    if(idx < paletteColors.length-1){
                        [paletteColors[idx+1], paletteColors[idx]] = [paletteColors[idx], paletteColors[idx+1]];
                        updateAll();
                    }
                });
                const removeBtn = document.createElement('span');
                removeBtn.textContent = '削除';
                removeBtn.className = 'color-remove';
                removeBtn.addEventListener('click', () => {
                    paletteColors.splice(idx, 1);
                    updateAll();
                });
                item.appendChild(colorInput);
                item.appendChild(leftBtn);
                item.appendChild(rightBtn);
                if (paletteColors.length > 1) item.appendChild(removeBtn);
                paletteColorsDiv.appendChild(item);
            });
            // 追加ボタン制御
            addPaletteColorBtn.disabled = paletteColors.length >= 7;
        }

        // パレット色重複除去（後ろを消す）
        function mergePaletteColors() {
            let seen = new Set();
            paletteColors = paletteColors.filter((color, idx) => {
                if (seen.has(color)) return false;
                seen.add(color);
                return true;
            });
        }

        // 出力更新
        function updateAll() {
            mergePaletteColors();
            renderPaletteColors();
            paletteStr = `${blackPenColor},${backgroundColor}|${paletteColors.join(',')}|${changeableColor}`;
        }

        // 追加ボタンのイベント
        addPaletteColorBtn.addEventListener('click', () => {
            if (paletteColors.length < 7) {
                const used = new Set(paletteColors);
                const candidate = defaultColors.find(c => !used.has(c));
                paletteColors.push(candidate || '#FFFFFF');
                updateAll();
            }
        });

        // 入力イベント
        blackPenColorInput.addEventListener('input', e => {
            blackPenColor = e.target.value;
        });
        backgroundColorInput.addEventListener('input', e => {
            backgroundColor = e.target.value;
        });
        changeableColorInput.addEventListener('input', e => {
            changeableColor = e.target.value;
        });

        // 変数→input要素へ反映
        function syncInputs() {
            blackPenColorInput.value = blackPenColor;
            backgroundColorInput.value = backgroundColor;
            changeableColorInput.value = changeableColor;
        }

        // パレットセット反映
        function applyPaletteSet(str) {
            let [mainPart, palettePart, changeablePart] = str.split('|');
            let [bpc, bgc] = (mainPart || '').split(',');
            if(bpc) blackPenColor = bpc;
            if(bgc) backgroundColor = bgc;
            paletteColors = palettePart ? palettePart.split(',') : [...defaultColors];
            changeableColor = changeablePart || defaultChangeableColor;
            syncInputs();
            updateAll();
        }

        // 初期描画
        syncInputs();
        updateAll();
        renderPaletteSetList();
    </script>
</body>
</html>
